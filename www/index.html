<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DriveSafe</title>
    <link rel="stylesheet" href="css/index.css">
</head>
<body>
    <div style="text-align: center; font-size: 24px;"></div>
    </div>
    <script type="text/javascript" src="cordova.js"></script>
    <h1>DriveSafe</h1>
    <div class="button-container">
        <button id="startButton">Start</button>
        <button id="stopButton" disabled>Stop</button>
    </div>
    <br>
    <span id="speedCounter">Speed: 0 mph</span>
    <br><br>
    <div class="logo-container">
        <img src="img/google-maps.png" alt="Google Maps" onclick="openGoogleMaps()">
        <img src="img/spotify.png" alt="Spotify" onclick="openSpotify()">
    </div>
    <script>
      let watchID;
        let lastTime = null;
        let setSpeed = 0;
        let lastAcceleration = null;
        let belowSpeedLimit = false;
        let speedBelowStartTime = null; 
        let speedBelowAccumulatedTime = 0; 
        const speedThreshold = 15; 
        const requiredBelowTime = 2 * 60 * 1000; 
        let abletostop = false;

        function startTracking() {
            if (navigator.geolocation) {
                watchID = navigator.geolocation.watchPosition(onSuccess, onError, {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                });
            } else {
                document.getElementById('speedCounter').innerHTML = "Geolocation not supported";
            }
        }
        function onSuccess(position) {
            const speedMps = position.coords.speed; 
            const speedMph = (speedMps * 2.23694).toFixed(2);
            setSpeed = speedMph;
            document.getElementById('speedCounter').innerHTML = `Speed: ${speedMph} mph`;
            const currentTime = new Date().getTime();
            if (speedMps !== null && speedMph < speedThreshold) {
                if (!speedBelowStartTime) {
                    speedBelowStartTime = currentTime; 
                } else {
                    speedBelowAccumulatedTime += (currentTime - speedBelowStartTime);
                    speedBelowStartTime = currentTime;

                    if (speedBelowAccumulatedTime >= requiredBelowTime) {
                        abletostop = true;
                    }
                }
            } else {
                resetBelowSpeedTracking();
            }
        }
        function resetBelowSpeedTracking() {
            speedBelowStartTime = null;
            speedBelowAccumulatedTime = 0;
        }
        function onError(error) {
            alert(`Error Code: ${error.code} - ${error.message}`);
        }
    function openGoogleMaps() {
        cordova.InAppBrowser.open("https://www.google.com/maps")

    }

    function openSpotify() {
                cordova.InAppBrowser.open("https://open.spotify.com")
  
    }
    

startButton.addEventListener('click', function() {

    navigator.notification.confirm(
    'By confirming, this app will lock your phone until it has determined that you are not driving. Are you sure you want to proceed?', 
     start,          
    'Are you sure?',        
    ['Yes','No']   
);
});
stopButton.addEventListener('click', function() {
    if (abletostop == true) {
        navigator.notification.alert(
        'Stopping Lockdown',  
        alertDismissed,        
        'Done',            
        'Ok'                 
    );
        window.plugins.locktask.stopLockTask();
        document.getElementById('startButton').disabled = false;
    }
    else {
        const speedMph = (setSpeed * 2.23694).toFixed(2);
        if (speedMph > speedThreshold) {
            navigator.notification.alert(
        `You cannot stop the lockdown yet. Your speed must be under ${speedThreshold} mph for at least 2 minutes. `,  
        alertDismissed,        
        'Error',            
        'Ok'                 
    );
    }
    else if (speedMph < speedThreshold) {
        let timeRemaining = Math.max((requiredBelowTime - speedBelowAccumulatedTime) / 1000, 0)
        navigator.notification.alert(
        `You cannot stop the lockdown yet. You still need to wait ${timeRemaining.toFixed(1)} seconds.`,  
        alertDismissed,        
        'Error',            
        'Ok'                 
    );
    }
}
});
function alertDismissed() {
    navigator.notification.dismissPrevious([successCallback], [errorCallback])
}
function start(s) {
    if (s == 1) {
        document.getElementById('stopButton').disabled = false;
        navigator.notification.alert(
        'Lockdown has started',  
        alertDismissed,         
        'Lockdown',            
     'Ok'                 
);
        window.plugins.locktask.startLockTask();
        document.getElementById('startButton').disabled = true;
        startTracking();
    }
    else {
        navigator.notification.alert(
    'Lockdown cancelled',  
    alertDismissed,        
    'Lockdown',            
    'Ok'                 
);
document.getElementById("speedCounter").innerHTML = "Speed: 0 mph";
    }

    
} 
    </script>
</body>
</html>